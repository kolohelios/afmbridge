name: CI

on:
  push:
    branches: [main]
  pull_request:

jobs:
  validate:
    name: Validate
    # macOS 26 provides FoundationModels framework for real AFM testing
    runs-on: macos-26
    steps:
      - uses: actions/checkout@v4

      # Cache Swift Package Manager dependencies
      # Caches: SPM cache, checkouts, and repositories
      # Key: hash of Package.resolved for deterministic cache invalidation
      - name: Cache SPM dependencies
        uses: actions/cache@v4
        with:
          path: |
            ~/Library/Caches/org.swift.swiftpm
            .build/checkouts
            .build/repositories
          key: ${{ runner.os }}-spm-${{ hashFiles('Package.resolved') }}
          restore-keys: |
            ${{ runner.os }}-spm-

      # Cache Homebrew packages (swift-format, swiftlint)
      # Saves ~8 seconds per CI run
      - name: Cache Homebrew packages
        uses: actions/cache@v4
        with:
          path: |
            /opt/homebrew/Cellar/swift-format
            /opt/homebrew/Cellar/swiftlint
          key: ${{ runner.os }}-homebrew-${{ hashFiles('.github/workflows/ci.yml') }}
          restore-keys: |
            ${{ runner.os }}-homebrew-

      # Install Swift tooling via Homebrew (not Nix)
      # Reason: nixpkgs only has Swift 5.10, but we need Swift 6+
      # System Xcode provides Swift 6.1.2 on macos-15
      - name: Install Swift tools
        run: |
          brew install swift-format swiftlint
          brew link --overwrite swift-format swiftlint || true

      - name: Cache Swift build artifacts
        uses: actions/cache@v4
        with:
          path: .build
          key: ${{ runner.os }}-swift-${{ hashFiles('**/Package.resolved') }}
          restore-keys: |
            ${{ runner.os }}-swift-

      - name: Install Nix
        uses: cachix/install-nix-action@v30
        with:
          extra_nix_config: |
            experimental-features = nix-command flakes

      - name: Check Nix flake
        run: nix flake check

      - name: Validate (format + lint + test + build)
        run: |
          nix develop --command just validate

      # TODO: Re-enable in Phase 1 when tests exist
      # - name: Check code coverage
      #   run: |
      #     nix develop --command bash -c '
      #       swift test --enable-code-coverage
      #       COVERAGE=$(xcrun llvm-cov export \
      #         .build/debug/afmbridgePackageTests.xctest/Contents/MacOS/afmbridgePackageTests \
      #         --instr-profile .build/debug/codecov/default.profdata \
      #         --format=lcov 2>/dev/null | grep -o "LF:[0-9]*" | cut -d: -f2 | awk "{s+=\$1} END {print s}")
      #       LINES=$(xcrun llvm-cov export \
      #         .build/debug/afmbridgePackageTests.xctest/Contents/MacOS/afmbridgePackageTests \
      #         --instr-profile .build/debug/codecov/default.profdata \
      #         --format=lcov 2>/dev/null | grep -o "LH:[0-9]*" | cut -d: -f2 | awk "{s+=\$1} END {print s}")
      #       if [ -n "$LINES" ] && [ -n "$COVERAGE" ] && [ "$COVERAGE" -gt 0 ]; then
      #         PERCENT=$((LINES * 100 / COVERAGE))
      #         echo "Code coverage: ${PERCENT}%"
      #         if [ "$PERCENT" -lt 80 ]; then
      #           echo "Error: Code coverage is below 80%"
      #           exit 1
      #         fi
      #       else
      #         echo "Warning: Could not calculate coverage (no tests yet)"
      #       fi
      #     '

      # TODO: Re-enable in Phase 1 when Swift build works
      # - name: Build Docker image
      #   run: nix build .#docker
